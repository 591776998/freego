<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link href="__PUBLIC__/css/bootstrap.css" rel="stylesheet">
    <link rel="stylesheet" href="__PUBLIC__/css/flatpickr.min.css">
    <link rel="stylesheet" href="__PUBLIC__/css/ie.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="keywords" content="" />
    <script type="application/x-javascript"> addEventListener("load", function() { setTimeout(hideURLbar, 0); }, false); function hideURLbar(){ window.scrollTo(0,1); } </script>
    <style>

        @media (min-width:992px) {
            .row{
                width: 60%;
                margin: 0 auto;
                border-right: 2px solid #DDDDDD;
                border-left: 2px solid #DDDDDD;
            }
            .imgCom{
                width: 100%;
                height:135px;
                margin: 10px 0;
                background: #F2F2F2 ;
            }
            .main{
                padding: 10px 8px;
                margin: 0 18%;
            }

        }
        @media (max-width:376px){
            .comment{
                font-size:7px;
                padding-top: 10px;
                color: #979797;
                font-weight:bold;
            }
        }
        @media (min-width:410px){
            .comment{
                font-size:1.1em;
                padding-top: 10px;
                color: #979797;
                letter-spacing:0.5px;
                font-weight:bold;
            }
        }
        a:hover{
            cursor: pointer;
        }
        .main{
            padding: 10px 8px;

        }

        .span1{
            background: #D8D8D8;
            padding: 3px 10px;
            margin:0 10px;
            font-weight:normal;
            border: none;
            height: 25px;
            width: 140px;
        }
        .span2{

            padding: 6px 10px;
            font-size: 1.0em;
            font-weight: normal;

        }
        .btn{
            border-radius: 7px;
            margin-left:5px ;
            font-size: 0.9em;
            margin-bottom:5px ;
            padding: 2px;
            color: #979797;
            height: 28px;
            background: #FFFFFF;
            border: 1px solid #DDDDDD;

        }
        .btn1{
            border-radius: 7px;
            margin-left:5px ;
            font-size: 0.9em;
            margin-bottom:5px ;
            padding: 2px 5px ;
            color: #0000ff;
            height: 28px;
            background: #FFFFFF;
            border:none;

        }

        select{
            width: 60%;
            height: 20px;
            color: #000000;
            font-size: 15px;
        }
        a{
            color:#0000ff;
            margin: 0 10px;
        }
        .imgCom{
            width: 100%;
            height: 60px;
            margin: 10px 0;
            background: #F2F2F2 ;
        }
        textarea{
            background: #F2F2F2;
            width: 100%;
            border:none;
        }
        .comm{
            margin: 25px 0px;
        }
        .img_input_wrap{
            position: relative;
        }
        .img_input_wrap .delete_btn{
            position: absolute;
            width: 30px;
            height: 30px;
            top: 0;
            right: 0;
            cursor: pointer;
        }

    </style>

    <!--/script-->

</head>
<body>
<div class="container">
    <form id="main_form" enctype="multipart/form-data" method="post">
    <div class="row">
        <div class="col-xs-12 col-md-8 main">
            <h2 style="font-weight: bolder">地点（商家）<span style="font-size: 16px;color: #666;margin-left: 60px;">{{$data.id}}</span></h2>

            <div class="comment">
                <div class="comm"> <input name="id" value="{{$data.id}}" hidden /></div>
                <div class="comm">
                    <label>
                        <input name="notice" value="101" type="checkbox" {{eq name="data.notice" value="101"}}checked="checked" {{/eq}}  />
                        <span class="span2">新增订单时通知负责人</span>
                    </label>
                </div>
                <div class="comm">发展组织:<input type="text" class="span1" style="width: 280px" placeholder="请输入组织名" /></div>
                <div class="comm">地点名称:<input type="text" name="title" value="{{$data.title}}" class="span1" style="width: 280px" placeholder="输入名称" /></div>
                <div class="comm">
                地点分类
                <select name="type" class="type_select">
                    <option {{eq name="data.type" value="101"}}selected="selected"{{/eq}} value="101">景点</option>
                    <option {{eq name="data.type" value="102"}}selected="selected"{{/eq}} value="102">美食</option>
                    <option {{eq name="data.type" value="103"}}selected="selected"{{/eq}} value="103">酒店</option>
                    <option {{eq name="data.type" value="104"}}selected="selected"{{/eq}} value="104">娱乐</option>
                    <option {{eq name="data.type" value="105"}}selected="selected"{{/eq}} value="105">购物</option>
                    <option {{eq name="data.type" value="106"}}selected="selected"{{/eq}} value="106">租车</option>
                    <option {{eq name="data.type" value="107"}}selected="selected"{{/eq}} value="107">保险</option>
                    <option {{eq name="data.type" value="108"}}selected="selected"{{/eq}} value="108">证照</option>
                    <option {{eq name="data.type" value="109"}}selected="selected"{{/eq}} value="109">折扣</option>
                    <option {{eq name="data.type" value="110"}}selected="selected"{{/eq}} value="110">汽车服务</option>
                    <option {{eq name="data.type" value="111"}}selected="selected"{{/eq}} value="111">道路救援</option>
                    <option {{eq name="data.type" value="112"}}selected="selected"{{/eq}} value="112">积分兑换</option>
                </select>
                </div>
                <div class="comm">
                地点标签
                <select class="tag_select">
                    {{volist name="tag" id="vo"}}
                    {{eq name="data.type" value="$vo['sub_type']"}}
                    <option value="{{$vo.id}}">{{$vo.tag_name}}</option>
                    {{/eq}}
                    {{/volist}}
                </select>
                <button type="button" class="btn add_tag_btn">添加标签</button>
               </div>
                <div class="tag_wrap">
                    {{volist name="data.tag" id="vo"}}
                    <div><input name="tag[]" value="{{$vo.id}}" hidden/>{{$vo.tag_name}}<button type="button" class="btn btn1 tag_del_btn">删除</button></div>
                    {{/volist}}
                </div>

                封面图片<br />
                <div class="col-xs-12 img_input_cover">
                    <img src="{{$data.img_url}}" class="imgCom" style="width: 90px;height: 90px;">
                    <input name="img" class="input hide" type="file" hidden />
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xs-12 col-md-8 main">
            <div class="comment col-xs-12 col-md-12 img_wrap" >

                详情图片（最多8张）<br />
                {{volist name="data.album" id="vo"}}
                <div class="col-xs-3 img_input_wrap">
                    <div class="img_input">
                        <img class="imgCom" src="{{$vo.url}}">
                        <input name="album_id[]" value="{{$vo.id}}" class="hide img_id_input" hidden />
                    </div>
                    <img class="delete_btn" src="http://www.tp5.local/static/img/delete.png">
                </div>
                {{/volist}}
                <div class="col-xs-3 img_input_wrap">
                    <div class="img_input">
                        <img class="imgCom" src="">
                        <input name="album_id[]" value="" class="hide img_id_input" hidden />
                    </div>
                </div>

            </div>
            <div class="comment">
                <div>
                    <div class="comm">扫码给用户打的折扣<input name="discount" value="{{if condition="is_numeric($data['discount'])"}}{{$data.discount/1000}}{{/if}}" class="span1" placeholder="输入范围0-10" />折</div>
                    <div class="comm">平台提成百分比&nbsp&nbsp<input disabled="disabled" value="{{if condition="is_numeric($data['percentage'])"}}{{$data.percentage/100}}{{/if}}" class="span1" placeholder="输入范围0-100" />%</div>
                    <div class="comm">
                    地点的简介：
                    <textarea name="content">{{$data.content|trim}}</textarea>
                    </div>
                </div>
                <div>
                    <div class="comm">营业时间：<input name="run_s_time" value="{{$data.run_s_time|date='H:i',###-28800}}" type="time" class="span1 flatpickr" style="width: 100px" />到<input name="run_e_time" class="flatpickr span1" value="{{$data.run_e_time|date='H:i',###-28800}}"  type="time" style="width: 100px" /></div>
                    <div class="comm">联系电话（座机）：<input name="landline" value="{{$data.landline}}" type="text" class="span1" style="width: 200px"/></div>
                    <div class="comm"> 联系电话（手机）：<input name="phone" value="{{$data.phone}}" type="text" class="span1" style="width: 200px"/></div>
                    <div class="comm">
                    <a id="btnpage2" class="btn create_services_btn" href="{{:web_url('/seller/Services/create.html',['place_id'=>$data['id']])}}" target="_blank" style="padding: 0 15px">+创建服务商品</a>
                    </div>
                    <div class="services_wrap">
                        {{volist name="data.services" id="vo"}}
                        <div class="services_item" data-id="{{$vo.id}}" >
                            <span>{{$vo.title}}</span><a class="btn btn1 delete">删除</a><a href="{{:web_url('/seller/Services/editor.html',['id'=>$vo['id']])}}" target="_blank" class="btn btn1">修改</a>
                        </div>
                        {{/volist}}
                    </div>
                </div>

                <br>
                <div>
                    商家地址：<br />
                    <div class="comm">详细地址：<input name="address" value="{{$data.address}}"  type="text" class="span1" style="width: 100px"  /></div>
                        <div class="comm">精度：<input class="span1" name="bd_lng" value="{{$data.bd_lng}}" style="width: 100px" placeholder="最低小数点六位" /> 纬度:<input name="bd_lat" value="{{$data.bd_lat}}" class="span1" style="width:100px"  placeholder="最低小数点六位" /></div>
                    <div class="park_wrap">
                        {{volist name="data.park" id="vo"}}
                         <div class="park_item_wrap">停车地点：<br />
                            <div class="comm"> <input name="park[{{$i-1}}][id]" value="{{$vo.id}}" hidden /></div>
                            <div class="comm">名称：<input name="park[{{$i-1}}][title]" value="{{$vo.title}}"  type="text" class="span1" style="width: 100px"  /><label><input name="park[{{$i-1}}][touring]" value="101" {{eq name="vo.touring" value="101"}}checked="checked"{{/eq}} type="checkbox" />是否可以停房车</label></div>
                             <div class="comm">经度：<input name="park[{{$i-1}}][bd_lng]" value="{{$vo.bd_lng}}" class="span1" style="width: 100px"  placeholder="最低小数点六位" /> 纬度:<input name="park[{{$i-1}}][bd_lat]" value="{{$vo.bd_lat}}" class="span1" style="width:100px"  placeholder="最低小数点六位" /></div>
                            </div>
                        {{/volist}}
                    </div>
                    <a class="add_park_btn">添加一个停车地点</a><a class="park_del_btn">删除最后一个停车点</a>
                </div>
            </div>
        </div>
    </div>
        <div class="row">
            <button type="reset" class="btn">取消</button> <button type="button" class="btn" id="submit">保存</button>
        </div>
    </form>
</div>
<script src="__PUBLIC__/js/jquery.3.2.1.js"> </script>
<script src="__PUBLIC__/js/bootstrap.js"></script>
<script src="__PUBLIC__/js/flatpickr.min.js"></script>
<script src="__PUBLIC__/js/seller.js"></script>
<script type="text/javascript">
    var all_tag = {{$tag|json_encode}};
</script>
<script type="text/javascript">

    $(function(){

        //标签
        tagSelect();

        //异步上传相册图片
        imgInput();

        //停车
        park();

        //封面图
        imgCoverInput();

        //删除服务按钮
        deleteServices();

        $('#submit').on('click',function () {
            var formData = new FormData(document.querySelector('#main_form'));
            $.ajax({
                type: "POST",
                url: "{{:web_url('/seller/Place/update')}}",
                data: formData,
                cache: false,
                contentType: false,
                processData: false,
                success: function(data) {
                    if(200 == data.code){
//                        window.opener.services_callback(data.data);
                        msg('保存成功 ！！',1);
                    }else{
                        msg(data.desc,2);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    msg("保存失败，请检查网络后重试",2);
                }
            });
        });

        var tag_select = $('.tag_select');
        $('.type_select').on('change',function(){
            //替换
            flushTagSelect(tag_select,all_tag,$(this).val());
        });

        flatpickr(".flatpickr", {
            enableTime: true,
            noCalendar: true,
            enableSeconds: false,
            time_24hr: true,
            dateFormat: "H:i",
            defaultHour: 12,
            defaultMinute: 0
        });
    });

    //更换select内的内容
    function flushTagSelect($dom,data,t) {
        var html = [];
        data.map(function (e,i) {
            if(t == e.sub_type){
                html += '<option value="'+e.id+'">'+e.tag_name+'</option>';
            }
        });
        $dom.find('option').remove();
        $dom.append(html);
    }


    //设置删除服务按钮
    function deleteServices() {
        $('.services_wrap').on('click','.delete',function () {
            var wrap = $(this).parent();
            $.ajax({
                type: "POST",
                url: "{{:web_url('/seller/services/delete')}}",
                data: {id:wrap.data('id')},
                cache: false,
                success: function(data) {
                    if(200 == data.code){
                        wrap.remove();
                        msg('删除成功',1);
                    }else{
                        msg(data.desc,2);
                    }
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    msg("删除失败，请检查网络后重试",2);
                }
            });
        });
    }

    //设置标签新增 和删除
    function tagSelect() {
        var tag_select = $('.tag_select');
        var tag_wrap = $('.tag_wrap');
        $('.add_tag_btn').on('click',function () {
            //如果选择了已经存在的标签
            var the_vaue = tag_select.val();
            var has = tag_wrap.find("input[value='"+the_vaue+"']");
            if(!has[0]){
                var dom = '<div><input name="tag[]" value="'+the_vaue+'" hidden/>'+tag_select.find("option:selected").text()+'<button class="btn btn1 tag_del_btn">删除</button></div>';
                tag_wrap.append(dom);
            }else {
                msg('已经有了',3);
            }
        });

        //绑定删除按钮的事件
        tag_wrap.on('click','.tag_del_btn',function(){
            $(this).parent().remove();
        })

    }

    //封面
    function imgCoverInput() {
        var can = true;
        $('.img_input_cover').on('click',function (e) {
            if(can){
                can = false;
                var input = $(this).find('.input');
                input.trigger("click");
                can = true;
            }
        });
        $('.img_input_cover').on('change','.input',function () {
            var parent = $(this).parent();
            var objUrl = getObjectURL(this.files[0]) ;
            if (objUrl) {
                parent.find('img').attr("src", objUrl) ; //将图片路径存入src中，显示出图片
            }
        });
    }

    //相册
    function imgInput() {
        var can = true;
        var now_div = null;
        var img_form = $('.img_form');
        if(img_form.length <= 0){
            $('body').append('<form method="post"   enctype="multipart/form-data" class="hide img_form">' +
                    '<input name="image_type" value="103" />' +
                    '<input name="img"  class="input img_file_input" type="file" />' +
                    '</from>');
        }

        $('.img_wrap').on('click','.img_input',function (e) {
            if(can){
                can = false;
                $('.img_form').find('.img_file_input').trigger("click");
                now_div = $(this);
                can = true;
            }
        });

        //用户选择文件以后
        $('form.img_form').on('change','.img_file_input',function () {
            uploadImg($(this).parent(),now_div,getObjectURL(this.files[0]));
        });

        $('body').on('click','.img_input_wrap .delete_btn',function () {
            var parent = $(this).parent();
            if(confirm('您确认要删除该图片？')){
                parent.remove();
            }
        });
    }

    //停车
    function park() {
        var park_wrap = $('.park_wrap');
        $('.add_park_btn').on('click',function () {
            //当前有多少个停车点
            var num = park_wrap.find('.park_item_wrap').length;
            if(3 > num){
                var dom = '<div class="park_item_wrap">停车地点：<br />'+
                        ' <div class="comm">名称：<input name="park['+num+'][title]" type="text" class="span1" style="width: 100px"  /><label><input name="park['+num+'][touring]" value="101" type="checkbox" />是否可以停房车</label></div>'+
                        ' <div class="comm">精度：<input name="park['+num+'][bd_lng]" type="number" class="span1" style="width: 100px"  placeholder="最低小数点六位" /> 纬度:<input name="park['+num+'][bd_lat]" type="number" class="span1" style="width:100px"  placeholder="最低小数点六位" /></div>' +
                        '</div>';
                park_wrap.append(dom);
            }
        });
        $('.park_del_btn').on('click',function () {
            park_wrap.children('.park_item_wrap:last-child').remove();
        });
    }


    //给子页面更新本页面的函数
    function services_callback(data) {
        //在服务div里面，查找如果有同id的子元素，修改，否则，新增
        var services_item = $('.services_wrap .services_item[data-id='+data.id+']');
        if(services_item.length>0){
            //已存在
            services_item.find('span').text(data.title);
        }else{
            //不存在
            var dom = '<div class="services_item" data-id="'+data.id+'" > <span>'+data.title+'</span><a  class="btn btn1">删除</a><a href="{{:web_url('/seller/Services/editor')}}?id='+data.id+'" target="_blank" class="btn btn1">修改</a> </div>';
            $('.services_wrap').append(dom);
        }
        return true;
    }

    //****************** 异步上传文件 *********************
    function uploadImg(form,that,img_local_path) {
        var formData = new FormData(form[0]);
        var the_wrap = that.parent();
        var parent   = that.parent().parent();
        that.find('img').attr("src",img_local_path);
        if(0 == that.nextAll().length && 8 > parent.children('div').length){
            var dom = '<div class="col-xs-3 img_input_wrap">'+
                    '<div class="img_input">' +
                    '<img class="imgCom">'+
                    '<input name="album_id[]" value="" class="hide img_id_input" hidden />' +
                    '</div></div>'
            the_wrap.append('<img class="delete_btn" src="http://www.tp5.local/static/img/delete.png">');
            parent.append(dom);
        }
        $.ajax({
            type: "POST",
            url: "{{:web_url('/image/save')}}",
            data: formData,//.serialize(),
            cache: false,
            contentType: false,
            processData: false,
            success: function(data) {
                if(200 == data.code){
                    //把图片id，填入
                    that.find('.img_id_input').val(data.data.id);
                }else{
                    msg('图片上传失败！',2);
                }
            },
            error: function(XMLHttpRequest, textStatus, errorThrown) {
                msg("上传失败，请检查网络后重试",2);
            }
        });
    }
</script>
<a href="#to-top" id="toTop" style="display: block;"> <span id="toTopHover" style="opacity: 1;"> </span></a>
<!---->

</body>
</html>